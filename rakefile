require 'fileutils'

def safe_task(&block)
    yield
rescue Exception => problem
    puts "rake task interrupted: #{problem}"
end

deep_clean_list = [
    "build",
    "build/lib/*.a",
    "build/lib/*/cmake_install.cmake",
    "build/lib/*/CMakeFiles",
    "build/lib/*/Makefile",
    "build/lib/gmock/gtest",
    "lib/*.a",
]

laundry_list = [
    "build/CMakeCache.txt",
    "build/CMakeFiles",
    "build/CTestTestfile.cmake",
    "build/Makefile",
    "build/Testing",
    "build/bin",
    "build/cmake_install.cmake",
    "build/src",
    "build/test"
]

desc 'Cleans the project by deleting everything listed in the laundry list'
task :clean do
    puts 'Executing clean...'

    count = 0
    laundry_list.each do |laundry_item|
        count += 1
        sh "rm -rf #{laundry_item}"
    end

    puts "Cleaned #{count} files"
end

desc 'Deep cleans the project by deleting everything listed in the laundry list and the deep clean list (includes libraries)'
task :deepclean do
    Rake::Task["clean"].invoke
    puts 'Executing deep clean...'

    count = 0
    (laundry_list + deep_clean_list).each do |laundry_item|
        count += 1
        sh "rm -rf #{laundry_item}"
    end

    puts "Deep cleaned #{count} files"
end

desc 'Generates makefiles using CMake'
task :configure, :toolchain do |t, args|
  toolchain = args[:toolchain]

  toolchain_setting = "-DCMAKE_TOOLCHAIN_FILE=../toolchains/#{toolchain}" unless toolchain.nil?

  puts 'Executing configure...'
  mkdir_p('build')
  Dir.chdir('build') do
    sh "cmake #{toolchain_setting} .."
  end
end

desc 'Builds the application and unit tests using Make'
task :compile do
    puts 'Executing compile...'

    sh "make -C build"
end

desc 'Executes the unit tests'
task :test do
    puts 'Executing test...'

    begin
        sh "make -C build test"
        sh "cat build/Testing/Temporary/LastTest.log"
    rescue Exception => problem
        puts "rake task interrupted: #{problem}"
        sh "cat build/Testing/Temporary/LastTest.log"
        exit 1
    end
end

desc 'Starts the application'
task :start do
    puts 'Executing start...'

    sh "build/bin/glfw-skeleton"
end

desc 'Alias for rake configure compile test'
task :default do
    puts 'Executing default...'

    Rake::Task["configure"].invoke
    Rake::Task["compile"].invoke
    Rake::Task["test"].invoke
end

desc 'Alias for rake default start'
task :dstart do
    puts 'Executing default start'

    Rake::Task["default"].invoke
    Rake::Task["start"].invoke
end

desc 'Alias for rake clean default'
task :all do
    puts 'Executing all...'

    Rake::Task["clean"].invoke
    Rake::Task["default"].invoke
end
